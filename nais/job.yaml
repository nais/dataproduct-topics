apiVersion: "nais.io/v1"
kind: "Naisjob"
metadata:
  name: dataproduct-topics
  namespace: aura
  labels:
    team: aura
spec:
  image: "{{ image }}"
  schedule: "13 4 * * *"
  filesFrom:
    - secret: dataproduct-topics
      mountPath: /var/run/secrets/gcp/

  {{#if kafka_pool }}
  kafka:
    pool: "{{ kafka_pool }}"
  {{/if}}

  env:
    - name: POOL_NAME
      value: "{{ pool_name }}"
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /var/run/secrets/gcp/sa.json
  {{#if kafka_brokers }}
    - name: ONPREM
      value: "true"
    - name: KAFKA_BROKERS
      value: "{{ kafka_brokers }}"
    - name: LINKERD_AWAIT_DISABLED
      value: "no linkerd onprem!"

  webproxy: true
  {{/if}}

  {{#if kafka_serviceuser_vault_path }}
  vault:
    enabled: true
    paths:
      - kvPath: "{{ kafka_serviceuser_vault_path }}"
        mountPath: /var/run/secrets/nais.io/kafka_serviceuser
  {{/if}}
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    app: dataproduct-topics
  name: dataproduct-topics
  namespace: aura
type: Opaque
data:
  sa.json: {{ gcp_sa_json_base64 }}